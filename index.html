<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
        }

        .firebase-config {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .firebase-config h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #10b981;
        }

        .config-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .config-form input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .config-form input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-connect {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .setup-guide {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-guide h4 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .setup-guide ol {
            color: #92400e;
            padding-left: 20px;
        }

        .setup-guide li {
            margin-bottom: 5px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #3b82f6; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: start;
            opacity: 0.5;
            pointer-events: none;
        }

        .main-content.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .add-stock-form {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .add-stock-form h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .stocks-list {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .stocks-list h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 1.5em;
        }

        .stock-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .stock-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stock-symbol {
            font-size: 1.3em;
            font-weight: 700;
            color: #1f2937;
        }

        .stock-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            font-size: 0.9em;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            color: #6b7280;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
            font-size: 1.1em;
        }

        .no-stocks {
            text-align: center;
            color: #6b7280;
            font-size: 1.1em;
            padding: 40px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .auto-update-status {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: none;
        }

        .auto-update-status.show {
            display: block;
        }

        .update-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .last-update {
            color: #6b7280;
            font-size: 0.9em;
        }

        .next-update {
            color: #3b82f6;
            font-size: 0.9em;
            font-weight: 600;
        }

        .update-progress {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .update-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 1s ease;
        }

        .manual-update-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .manual-update-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stock-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .config-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Stock Portfolio Tracker</h1>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢ Firebase</p>
        </div>

        <div class="firebase-config" id="firebaseConfig">
            <h3>
                <div class="status-indicator" id="statusIndicator"></div>
                Firebase Connection
            </h3>
            
            <div class="setup-guide" id="setupGuide">
                <h4>üî• ‡∏ß‡∏¥‡∏ò‡∏µ Setup Firebase (‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß):</h4>
                <ol>
                    <li>‡πÑ‡∏õ <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Project ‡πÉ‡∏´‡∏°‡πà</li>
                    <li>‡πÄ‡∏õ‡∏¥‡∏î Firestore Database (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô test mode)</li>
                    <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà Project Settings > General > Web apps</li>
                    <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Web app ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å config ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
                </ol>
                <p style="color: #92400e; font-weight: 600; margin-top: 10px;">
                    üí° ‡∏´‡∏•‡∏±‡∏á connect ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£
                </p>
            </div>

            <div class="config-form">
                <input type="text" id="apiKey" placeholder="API Key">
                <input type="text" id="authDomain" placeholder="Auth Domain">
                <input type="text" id="projectId" placeholder="Project ID">
                <input type="text" id="storageBucket" placeholder="Storage Bucket">
                <input type="text" id="messagingSenderId" placeholder="Messaging Sender ID">
                <input type="text" id="appId" placeholder="App ID">
            </div>
            
            <button class="btn-connect" onclick="connectFirebase()">üîó Connect Firebase</button>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                <button onclick="showResetOptions()" style="background: none; border: none; color: #6b7280; font-size: 12px; cursor: pointer; text-decoration: underline;">
                    ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Firebase Project?
                </button>
            </div>
        </div>

        <div class="auto-update-status" id="autoUpdateStatus">
            <div class="update-info">
                <div>
                    <div class="last-update">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdateTime">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</span></div>
                    <div class="next-update">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ: <span id="nextUpdateTime">-</span></div>
                </div>
                <button class="manual-update-btn" id="manualUpdateBtn" onclick="updateAllPrices()">
                    üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
                </button>
            </div>
            <div class="update-progress">
                <div class="update-progress-bar" id="updateProgressBar"></div>
            </div>
            <div style="font-size: 0.8em; color: #6b7280; text-align: center;">
                üìä ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Yahoo Finance ‚Ä¢ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 09:30 ‡πÅ‡∏•‡∏∞ 15:30
            </div>
        </div>
            <div class="stat-card">
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="value neutral" id="totalStocks">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</h3>
                <div class="value neutral" id="totalInvestment">‡∏ø0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <div class="value neutral" id="currentValue">‡∏ø0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h3>
                <div class="value neutral" id="totalPnL">‡∏ø0</div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="add-stock-form">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="stockForm">
                    <div class="form-group">
                        <label for="symbol">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏∏‡πâ‡∏ô</label>
                        <input type="text" id="symbol" placeholder="‡πÄ‡∏ä‡πà‡∏ô AAPL, KBANK" required>
                    </div>
                    <div class="form-group">
                        <label for="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô</label>
                        <input type="number" id="quantity" placeholder="100" required>
                    </div>
                    <div class="form-group">
                        <label for="costPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ø)</label>
                        <input type="number" step="0.01" id="costPrice" placeholder="50.00" required>
                    </div>
                    <div class="form-group">
                        <label for="currentPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ø)</label>
                        <input type="number" step="0.01" id="currentPrice" placeholder="55.00" required>
                    </div>
                    <button type="submit" class="btn" id="addStockBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô</button>
                </form>
            </div>

            <div class="stocks-list">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <div id="stocksList">
                    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>

    <script>
        let db = null;
        let stocks = [];
        let isConnected = false;
        let updateInterval = null;
        let nextUpdateTimeout = null;

        // Yahoo Finance API endpoint (using proxy to avoid CORS)
        const YAHOO_API_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';

        // Auto update times (09:30 and 15:30)
        const UPDATE_TIMES = [
            { hour: 9, minute: 30 },
            { hour: 15, minute: 30 }
        ];

        // Load saved Firebase config
        window.onload = function() {
            loadSavedConfig();
        };

        function loadSavedConfig() {
            const config = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
            if (config.apiKey) {
                document.getElementById('apiKey').value = config.apiKey;
                document.getElementById('authDomain').value = config.authDomain;
                document.getElementById('projectId').value = config.projectId;
                document.getElementById('storageBucket').value = config.storageBucket;
                document.getElementById('messagingSenderId').value = config.messagingSenderId;
                document.getElementById('appId').value = config.appId;
                
                // Auto connect if config exists
                connectFirebase();
            }
        }

        async function connectFirebase() {
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                storageBucket: document.getElementById('storageBucket').value.trim(),
                messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };

            if (!config.apiKey || !config.projectId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key ‡πÅ‡∏•‡∏∞ Project ID ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢');
                return;
            }

            try {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                
                db = firebase.firestore();
                
                // Test connection
                await db.collection('stocks').limit(1).get();
                
                // Save config
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // Update UI - Hide Firebase config completely after successful connection
                document.getElementById('firebaseConfig').style.display = 'none';
                document.getElementById('mainContent').classList.add('enabled');
                
                isConnected = true;
                
                // Setup form handler
                setupFormHandler();
                
                // Load stocks
                await loadStocks();
                
                // Start auto update system
                startAutoUpdateSystem();
                
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ\n‡∏™‡πà‡∏ß‡∏ô setup ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!');
                
            } catch (error) {
                console.error('Firebase connection error:', error);
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                document.getElementById('statusIndicator').classList.remove('connected');
            }
        }

        function setupFormHandler() {
            document.getElementById('stockForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addStock();
            });
        }

        async function addStock() {
            if (!isConnected) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const addBtn = document.getElementById('addStockBtn');
            addBtn.disabled = true;
            addBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const symbol = document.getElementById('symbol').value.toUpperCase().trim();
                const quantity = parseInt(document.getElementById('quantity').value);
                const costPrice = parseFloat(document.getElementById('costPrice').value);
                const currentPrice = parseFloat(document.getElementById('currentPrice').value);
                
                // Validation
                if (!symbol || isNaN(quantity) || isNaN(costPrice) || isNaN(currentPrice)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                if (quantity <= 0 || costPrice <= 0 || currentPrice <= 0) {
                    alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                    return;
                }
                
                const stock = {
                    symbol,
                    quantity,
                    costPrice,
                    currentPrice,
                    totalCost: quantity * costPrice,
                    currentValue: quantity * currentPrice,
                    pnl: (currentPrice - costPrice) * quantity,
                    pnlPercent: ((currentPrice - costPrice) / costPrice) * 100,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('stocks').add(stock);
                
                // Reset form
                document.getElementById('stockForm').reset();
                
                // Reload stocks
                await loadStocks();
                
                alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô ${symbol} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ`);
                
            } catch (error) {
                console.error('Error adding stock:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô';
            }
        }

        async function loadStocks() {
            if (!isConnected) return;

            try {
                const snapshot = await db.collection('stocks').orderBy('createdAt', 'desc').get();
                stocks = [];
                
                snapshot.forEach(doc => {
                    stocks.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateDashboard();
                displayStocks();
                
                // Show auto update status if we have stocks
                if (stocks.length > 0) {
                    document.getElementById('autoUpdateStatus').classList.add('show');
                    updateNextUpdateTime();
                }
                
            } catch (error) {
                console.error('Error loading stocks:', error);
                document.getElementById('stocksList').innerHTML = 
                    '<div class="no-stocks">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }

        async function deleteStock(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏∏‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ?')) return;

            try {
                await db.collection('stocks').doc(id).delete();
                await loadStocks();
                alert('‡∏•‡∏ö‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Error deleting stock:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function updateDashboard() {
            const totalStocks = stocks.length;
            const totalInvestment = stocks.reduce((sum, stock) => sum + stock.totalCost, 0);
            const currentValue = stocks.reduce((sum, stock) => sum + stock.currentValue, 0);
            const totalPnL = currentValue - totalInvestment;
            
            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
            document.getElementById('currentValue').textContent = formatCurrency(currentValue);
            
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = formatCurrency(totalPnL);
            pnlElement.className = `value ${totalPnL > 0 ? 'positive' : totalPnL < 0 ? 'negative' : 'neutral'}`;
        }

        function displayStocks() {
            const container = document.getElementById('stocksList');
            
            if (stocks.length === 0) {
                container.innerHTML = '<div class="no-stocks">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>';
                return;
            }
            
            container.innerHTML = stocks.map(stock => `
                <div class="stock-item">
                    <div class="stock-header">
                        <div class="stock-symbol">${stock.symbol}</div>
                        <button class="btn btn-danger" onclick="deleteStock('${stock.id}')">‡∏•‡∏ö</button>
                    </div>
                    <div class="stock-details">
                        <div class="detail-item">
                            <div class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                            <div class="detail-value">${stock.quantity.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                            <div class="detail-value">‡∏ø${stock.costPrice.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                            <div class="detail-value">‡∏ø${stock.currentPrice.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô</div>
                            <div class="detail-value">${formatCurrency(stock.totalCost)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                            <div class="detail-value">${formatCurrency(stock.currentValue)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
                            <div class="detail-value ${stock.pnl > 0 ? 'positive' : stock.pnl < 0 ? 'negative' : 'neutral'}">
                                ${formatCurrency(stock.pnl)} (${stock.pnlPercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showResetOptions() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á Firebase config ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á setup Firebase ‡πÉ‡∏´‡∏°‡πà')) {
                localStorage.removeItem('firebaseConfig');
                location.reload();
            }
        }

        // Convert Thai stock symbol to Yahoo format
        function convertToYahooSymbol(symbol) {
            // Thai stocks need .BK suffix for Yahoo Finance
            const thaiStocks = ['KBANK', 'SCB', 'BBL', 'KTB', 'TCAP', 'AOT', 'CPALL', 'CP', 'PTT', 'PTTEP', 'BANPU', 'TRUE', 'INTUCH', 'ADVANC', 'DTAC', 'SCC', 'SCCC', 'CPN', 'LH', 'HMPRO'];
            
            // Check if it's likely a Thai stock (common patterns)
            if (symbol.length <= 5 && (thaiStocks.includes(symbol.toUpperCase()) || /^[A-Z]{2,5}$/.test(symbol))) {
                return symbol.toUpperCase() + '.BK';
            }
            
            // For US stocks, return as-is
            return symbol.toUpperCase();
        }

        // Fetch stock price from Yahoo Finance
        async function fetchStockPrice(symbol) {
            try {
                const yahooSymbol = convertToYahooSymbol(symbol);
                const url = `${YAHOO_API_BASE}${yahooSymbol}?interval=1d&range=1d`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart?.result?.[0]?.meta?.regularMarketPrice) {
                    return {
                        symbol: symbol,
                        price: data.chart.result[0].meta.regularMarketPrice,
                        success: true
                    };
                } else {
                    console.warn(`No price data for ${symbol}`);
                    return { symbol: symbol, price: null, success: false };
                }
            } catch (error) {
                console.error(`Error fetching price for ${symbol}:`, error);
                return { symbol: symbol, price: null, success: false };
            }
        }

        // Update all stock prices
        async function updateAllPrices() {
            if (!isConnected || stocks.length === 0) return;

            const updateBtn = document.getElementById('manualUpdateBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';

            let updatedCount = 0;
            let totalStocks = stocks.length;

            try {
                // Update progress bar
                const progressBar = document.getElementById('updateProgressBar');
                
                for (let i = 0; i < stocks.length; i++) {
                    const stock = stocks[i];
                    
                    // Update progress
                    const progress = ((i + 1) / totalStocks) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // Fetch new price
                    const priceData = await fetchStockPrice(stock.symbol);
                    
                    if (priceData.success && priceData.price) {
                        // Update stock data
                        const newCurrentPrice = priceData.price;
                        const updatedStock = {
                            ...stock,
                            currentPrice: newCurrentPrice,
                            currentValue: stock.quantity * newCurrentPrice,
                            pnl: (newCurrentPrice - stock.costPrice) * stock.quantity,
                            pnlPercent: ((newCurrentPrice - stock.costPrice) / stock.costPrice) * 100,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // Update in Firestore
                        await db.collection('stocks').doc(stock.id).update(updatedStock);
                        updatedCount++;
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Reload data and update UI
                await loadStocks();
                
                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdateTime').textContent = now.toLocaleString('th-TH');
                localStorage.setItem('lastUpdateTime', now.toISOString());
                
                alert(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ\n‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏î‡πâ ${updatedCount}/${totalStocks} ‡∏ï‡∏±‡∏ß`);
                
            } catch (error) {
                console.error('Error updating prices:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤: ' + error.message);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ';
                
                // Reset progress bar after 2 seconds
                setTimeout(() => {
                    document.getElementById('updateProgressBar').style.width = '0%';
                }, 2000);
                
                // Update next update time
                updateNextUpdateTime();
            }
        }

        // Calculate next update time
        function getNextUpdateTime() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            for (const time of UPDATE_TIMES) {
                const updateTime = new Date(today.getTime() + time.hour * 60 * 60 * 1000 + time.minute * 60 * 1000);
                if (updateTime > now) {
                    return updateTime;
                }
            }
            
            // If past both times today, return first time tomorrow
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            return new Date(tomorrow.getTime() + UPDATE_TIMES[0].hour * 60 * 60 * 1000 + UPDATE_TIMES[0].minute * 60 * 1000);
        }

        // Update next update time display
        function updateNextUpdateTime() {
            const nextUpdate = getNextUpdateTime();
            document.getElementById('nextUpdateTime').textContent = nextUpdate.toLocaleString('th-TH');
        }

        // Check if it's time for auto update
        function checkAutoUpdate() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            for (const time of UPDATE_TIMES) {
                const updateTime = time.hour * 60 + time.minute;
                // Check if it's within 1 minute of update time
                if (Math.abs(currentTime - updateTime) <= 1) {
                    const lastAutoUpdate = localStorage.getItem('lastAutoUpdate');
                    const today = now.toDateString();
                    const timeKey = `${today}-${time.hour}:${time.minute}`;
                    
                    // Only update if we haven't done this specific time today
                    if (lastAutoUpdate !== timeKey) {
                        localStorage.setItem('lastAutoUpdate', timeKey);
                        updateAllPrices();
                        return;
                    }
                }
            }
        }

        // Start auto update system
        function startAutoUpdateSystem() {
            // Check every minute for auto update
            updateInterval = setInterval(() => {
                checkAutoUpdate();
                updateNextUpdateTime();
            }, 60000);
            
            // Load last update time from localStorage
            const lastUpdate = localStorage.getItem('lastUpdateTime');
            if (lastUpdate) {
                const lastUpdateDate = new Date(lastUpdate);
                document.getElementById('lastUpdateTime').textContent = lastUpdateDate.toLocaleString('th-TH');
            }
            
            updateNextUpdateTime();
        }

        // Stop auto update system
        function stopAutoUpdateSystem() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            if (nextUpdateTimeout) {
                clearTimeout(nextUpdateTimeout);
                nextUpdateTimeout = null;
            }
        }

        function formatCurrency(amount) {
            return `‡∏ø${Math.abs(amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    </script>
</body>
</html>